<!-- chat/templates/chat/private_chat.html -->
{% comment %} {% extends 'app/webkit/main.html' %}
{% load static %}
{% block title %} Chat with {{ other_user.username }}{% endblock %}

{% block content %} {% endcomment %}
{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>All Tickets</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

    <div style="
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: rgba(0, 0, 0, 0.4);
      padding: 10px 16px;
      border-radius: 8px;
      z-index: 1000;
      ">
      <a href="javascript:history.back()" style="
          text-decoration: none;
          color: #ffffff;
          font-weight: bold;
          font-size: 16px;
      ">
          &larr; Back
      </a>
    </div>

    <h2>CHAT</h2>

    <div id="chat-container"class="d-flex gap-2">
        <div id="chat-list-block" >
            <h2 class="text-center text-white">Chats </h2>
            <div class="data-scrollbar" data-scroll="1">
                <nav class="">
                    <ul id="" class="list-unstyled">
                        {% for client in clients %}
                                    <li class="py-2 px-3 mb-2 rounded">
                                        <a href="{% url 'chat-with-client' username=client.user.username %}" class="d-flex align-items-center text-decoration-none text-dark">                        
                                            {% if client.profile_image  %}
                                                <img src="{{ client.profile_image.url }}" class="rounded-circle me-3" width="40" height="40" alt="Profile">
                                            {% else %}
                                                <img src="{% static 'assets/img/image.png' %}" class="rounded-circle me-3" width="40" height="40" alt="Default">
                                            {% endif %}
                                            <span class="ml-4 fw-bold">{{ client.user.username }} ( {{ client.company_name}})</span>
                                        </a>
                                    </li>
                        {% empty %}
                            <h4>No clients added yet for chat.</h4>
                        {% endfor %}
                    </ul>
                </nav>
            </div>        
        </div>
        <div id="chat-block">
            <div id="chat-log">
                {% if  other_user %}
                    <h3 class="text-center text-white">Private Chat with {{ other_user.username }}</h3>
                {% else %}
                    <h3 class="text-center text-white">Private Chat </h3>
                    <h6 class=" text-white">Please select a user to start chatting.<h6>
                {% endif%}
                {% for message in messages %}
                    <div class="message {% if message.sender == request.user %}message-right{% else %}message-left{% endif %}">
                        <div class="message-content">
                            {{ message.message }}
                            <div class="timestamp">{{ message.timestamp|date:"H:i" }}</div> <!-- Add timestamp here -->
                        </div>
                    </div>
                {% endfor %}
            </div>
            <br>
            <div class="chat-input-container">
                <input type="text" id="chat-message-input" placeholder="Type your message...">
                <button id="chat-message-submit">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="#0ff808" viewBox="0 0 24 24" stroke-width="1.0" stroke="currentColor" class="size-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" />
                    </svg>
                </button>
            </div>
        </div>
    </div>


<style>
    #chat-block {
        width: 70%;
        margin-left:1%;
    }
    #chat-list-block {
        width: 20%;
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 15px;
        background-color:rgba(8, 8, 8, 0.66);
    }
    /* Chat log container */
    #chat-log {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 10px;
        height: 500px;
        overflow-y: auto;
        border: 1px solid #ccc;
        border-radius: 15px;
        background-color:rgba(8, 8, 8, 0.66);
    }

    /* Message container */
    .message {
        display: flex;
        max-width: 30%; /* Ensure messages don't exceed 70% of the container width */
        min-width: 10%; /* Ensure messages don't exceed 70% of the container width */
        padding: 10px;
        border-radius: 10px;
    }

    /* Current user's messages (right side) */
    .message-right {
        align-self: flex-end;
        background-color:rgb(10, 209, 73);
        color: white;
    }

    /* Other users' messages (left side) */
    .message-left {
        align-self: flex-start;
        background-color:#007bff;
        color: white;
    }

    /* Message content */
    .message-content {
        position: relative; /* Required for absolute positioning of the timestamp */
        word-wrap: break-word; /* Break long words */
        overflow-wrap: break-word; /* Break long words */
        max-width: 100%; /* Prevent overflow */
        padding-bottom: 20px; /* Add space for the timestamp */
    }

    /* Timestamp styling */
    .timestamp {
        position: absolute; /* Position the timestamp absolutely */
        align-self: flex-end;
        bottom: 5px; /* Adjust as needed */
        font-size: 0.75rem; /* Small font size */
        color:rgb(0, 3, 6); /* Subtle color */
        border-radius: 5px; /* Rounded corners */
    }

    /* Timestamp alignment for current user's messages (right side) */
    .message-right .timestamp {
        right: 5px; /* Align to the right */
        bottom: 0px;
    }

    /* Timestamp alignment for other user's messages (left side) */
    .message-left .timestamp {
        right: 5px; /* Align to the left */
        bottom: 0px;
    }

    {% comment %} /* Input and button container */
    #chat-message-input {
        width: calc(100% - 100px);
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 25px;
    }

    #chat-message-submit {
        width: 80px;
        padding: 10px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }

    #chat-message-submit:hover {
        background-color: #0056b3;
    } {% endcomment %}
     .chat-input-container {
  position: relative;
  width: 100%;
  display: inline-block;
}

#chat-message-input {
  width: 100%;
  padding: 10px 80px 10px 20px;
  border: 1px solid #ccc;
  border-radius: 25px;
  box-sizing: border-box;
}

#chat-message-submit {
  position: absolute;
  right: 5px;
  top: 50%;
  transform: translateY(-50%);
  width: 40px;
  height: 40px;
  padding: 0;
  {% comment %} background-color: #007bff; {% endcomment %}
  color: white;
  border: none;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  display: flex;
  align-items: center;
  justify-content: center;
}

#chat-message-submit:hover {
  background-color:rgb(0, 179, 54);
}
</style>
</body>
<script>
    const roomName = "{{ room.name }}";
    
    const chatSocket = new WebSocket(
        `ws://${window.location.host}/ws/chat/${roomName}/`
    );

    // Debugging: Log WebSocket connection status
    chatSocket.onopen = function (e) {
        console.log('WebSocket connection established');
    };

    chatSocket.onmessage = function (e) {
        console.log('Message received:', e.data);  // Debugging
        const data = JSON.parse(e.data);
        const messageElement = document.createElement('div');

        // Determine message alignment based on sender
        if (data.sender === "{{ request.user.username }}") {
            messageElement.className = 'message message-right';
        } else {
            messageElement.className = 'message message-left';
        }

        // Format the timestamp
        const timestamp = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        // Add message content and timestamp
        messageElement.innerHTML = `
            <div class="message-content">
                ${data.message}
            </div>
        `;

        // Append message to chat log
        document.querySelector('#chat-log').appendChild(messageElement);

        // Scroll to the bottom of the chat log
        const chatLog = document.querySelector('#chat-log');
        chatLog.scrollTop = chatLog.scrollHeight;
    };

    chatSocket.onclose = function (e) {
        console.error('WebSocket connection closed unexpectedly');
    };

    chatSocket.onerror = function (e) {
        console.error('WebSocket error:', e);
    };

    // Send message when the Send button is clicked
    document.querySelector('#chat-message-submit').onclick = function (e) {
        console.log('Send button clicked');  // This line for debugging
        const messageInput = document.querySelector('#chat-message-input');
        const message = messageInput.value;

        if (message.trim() === "") {
            console.error('Message is empty');
            return;
        }

        if (chatSocket.readyState === WebSocket.OPEN) {
            console.log('Sending message:', message);  // Debugging
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender': "{{ request.user.username }}",
                'timestamp': new Date().toISOString() // Include timestamp in the message
            }));
            messageInput.value = '';
        } else {
            console.error('WebSocket is not open.');
        }
    };

    // Send message when Enter key is pressed
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // Enter key
            document.querySelector('#chat-message-submit').click();
        }
    };
</script>

</html>